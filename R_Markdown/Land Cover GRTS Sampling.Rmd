---
title: "Project GRTS Sampling"
author: "Anna Kurtin"
date: "`r Sys.Date()`"
output: html_document
---


This is a markdown document to create



```{r Setup}
# Load in packages
packages <- c("data.table","sf","ggmap","terra","raster","mapview","tidyverse","rgdal","XML","methods","FedData","rasterVis","tidyterra","spsurvey", "spData", "usmap")
source(".\\R_Scripts\\Install_Load_Packages.R")
load_packages(packages)
```


```{r Establish Bounding Box}
# Bounding box coordinates from MRLC download 2/15:
ymin_proj <- 44.94910
ymax_proj <- 49.03619
xmin_proj <- -112.35849
xmax_proj <- -103.97674

#have to give st_bbox an object
# load in locations data
locs_dat <- fread(".\\Data\\Spatial_Data\\2022_ALLPoints.csv")
locs_dat <- na.omit(locs_dat)
locs_sf <- locs_dat %>% 
  st_as_sf(coords=c("long", "lat")) %>% st_set_crs(32100)
proj_bound <- st_bbox(locs_sf)

# lets reset the boundaries to what we want, the order is"
#xmin, ymin, xmax, ymax
proj_bound[1] <- xmin_proj
proj_bound[2] <- ymin_proj
proj_bound[3] <- xmax_proj
proj_bound[4] <- ymax_proj

```


```{r Read in Reprojected Land Cover Data}
# read in the updated, reprojected raster
lcov <- terra::rast(".\\Data\\Spatial_Data\\NLCD_2019_MTLandcoverProjected.tiff")
lcov <- as.factor(lcov)

# # Working with NLCD data: https://smalltownbigdata.github.io/feb2021-landcover/feb2021-landcover.html
# # load in the legend 
legend <- pal_nlcd()
#lcov_test <- merge(lcov, df, by = "ID")
#lcov_test <- lcov
vals <- unique(lcov[[1]])
# # pull out the values of the legend that are in the values of my map
df <- legend[legend$ID %in% vals$label,]
levels(lcov) <- df[,c("ID","Class")]
# need to relate the colors that it plots the raster to specific variables 
colors=c("#5475A8","#FFFFFF","#E8D1D1","#E29E8C","#ff0000","#B50000","#D2CDC0","#85C77E","#38814E","#D4E7B0","#DCCA8F","#FDE9AA","#FBF65D","#CA9146","#C8E6F8","#64B3D5")



# Read in hydrology layer
hydro <- st_read("E:\\MT_Spatial_Data\\MT_Lakes_Streams\\hd43a\\hd43a.shp")
# Combined study area
names <- c("Missouri River","Yellowstone River","Musselshell River")
proj_hydro <- hydro %>% filter(NAME %in% names)
proj_hydro <- proj_hydro %>% dplyr::select(NAME, geometry)
# Separate by river
hydro_miso <- hydro %>% filter(NAME == "Missouri River") %>% dplyr::select(NAME, geometry)
hydro_mush <- hydro %>% filter(NAME == "Musselshell River") %>% dplyr::select(NAME, geometry)
hydro_yell <- hydro %>% filter(NAME == "Yellowstone River") %>% dplyr::select(NAME, geometry)

# Create a buffer layer for each river
buff_miso <- st_buffer(hydro_miso, dist = 400)
buff_mush <- st_buffer(hydro_mush, dist = 400)
buff_yell <- st_buffer(hydro_yell, dist = 400)

# Mask land cover to only within the hydrology 
lcov_miso <- mask(lcov,buff_miso)
lcov_mush <- mask(lcov,buff_mush)
lcov_yell <- mask(lcov,buff_yell)


lcov_to_exclude <- c(11,12,21,22,23,24,31,81,82)

total_arus <- 45
# base sample is 15 along each river
```

GRTS Sampling

```{r Musselshell}
# RUN ONCE
## convert Spatraster to a raster object
## system.time(lcovrast_mush <- raster(lcov_mush))
## convert raster to polygons
## system.time(lcovpoly_mush <- rasterToPolygons(lcovrast_mush))
## DONT RUN THIS AGAIN
## make a shapefile of the polygon
## shapefile(lcovpoly_mush, ".\\Data\\Spatial_Data\\Landcover_Polygon_Musselshell.shp")

# read in the shapefile and make sure it is in a projected (not geographic) coordinate system
polys_mush <- st_read(".\\Data\\Spatial_Data\\Landcover_Polygon_Musselshell.shp") 


# create a list of the number of the samples you want for each strata
## NOTE you can't specify zero for this, put in 1 for the ones you don't want
# adjust this as needed later
n_strata <- c("11"=1,
              "21"=1,
              "22"=1,
              "23"=1,
              "24"=1,
              "31"=1,
              "41"=3,
              "42"=3,
              "43"=3,
              "52"=3,
              "71"=3,
              "81"=1,
              "82"=1,
              "90"=3,
              "95"=3)

## Say how many over samples you want for each strata
## here is where you can put zero in for classes you don't want 
n_oversamp <- c("11"=0,
              "21"=0,
              "22"=0,
              "23"=0,
              "24"=0,
              "31"=0,
              "41"=30,
              "42"=30,
              "43"=30,
              "52"=30,
              "71"=30,
              "81"=0,
              "82"=0,
              "90"=30,
              "95"=30)

# set the seed before running your sampling protocol so that you get the same randomness every time
## you can change this if you don't like how the distributions look 
set.seed(13)
unique(polys_mush$Class)

# set up your GRTS function
sampling_pts <- grts(sframe=polys_mush,
                     n_base=n_strata,# creates a list of the strata and how many points within each strata
                     stratum_var="Class", # what the ID/column in polygon data is that you're stratifying by 
                     n_over=n_oversamp) # gives you your extra spatially balanced points

# extract the main sampling points as a tibble
main_sampling_points <- as_tibble(sampling_pts$sites_base)
write.csv()
# extract the over sampled points
over_sampling_points <- as_tibble(sampling_pts$sites_over)
write.csv()

# filter out the strata that we don't want (the ones we had to specify to only sample one of)
main_samples_trimmed <- main_sampling_points %>% filter(!strata %in% lancov_to_exclude)
# add in a column for the names of each column 
main_samples_trimmed <- main_samples_trimmed %>% mutate(lancover == )
```





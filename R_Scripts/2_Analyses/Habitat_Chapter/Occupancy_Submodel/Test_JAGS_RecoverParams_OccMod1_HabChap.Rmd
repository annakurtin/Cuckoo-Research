---
title: "Recover Parameters for Simulated Data Occupancy Model"
author: "Anna Kurtin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(jagsUI)
library(tidyverse)
library(jagshelper)
library(ggplot2)
library(coda)
library(janitor)
library(loo)
source("C:/Users/annak/OneDrive/Documents/UM/Research/Coding_Workspace/Cuckoo-Research/R_Scripts/5_Visualization/Create_HexCodes_CuckooColorBlind.R")
source("C:/Users/annak/OneDrive/Documents/UM/Research/Coding_Workspace/Cuckoo-Research/R_Scripts/6_Function_Scripts/Create_SiteColumn_fromPointID.R")
```


# Simulate Data


```{R generate data, out.width = "50%", out.height = "50%"}
# b1/cov1: date - uniform, survey level
# b2/cov2: veg density - normal, site level
# b3/cov3: background noise - normal, survey level
# b4/cov4: effort - normal - survey level 

nP <- 107  # number of points
nV <- 6    # number of repeated visits
nC <- 8    # number of covariates
#survey_covs <- 3

# create latent state (z) and detection (y) data storage
z <- NULL        # point-level latent state
y <- array(NA, dim = c(nP, nV))   # point-level observation data

# create separate arrays for each covariate and fill with randomly generated data
# Covariate 1: Tree Richness
set.seed(22)
rich_vals <- c(-0.617, 0.71, 2.03, 3.37) # Create possible values for species richness
tree_rich <- sample(rich_vals, nP, replace =TRUE)
hist(tree_rich, col = cuckoo_palette[1], main = "Distribution of Simulated Native Broadleaf Richness")

# Covariate 2: Shrub Community
set.seed(3)
com_fs <- c(1:5)
shrub_com <- sample(com_fs, nP, replace = TRUE)
hist(shrub_com, col = cuckoo_palette[1], main = "Distribution of Simulated Shrub Community")

# Covariate 3: Subcanopy Veg Avg Height
set.seed(10)
subcan_h <- rnorm(nP, mean = 1, sd = 1)
hist(subcan_h, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Subcanopy Height")

# Covariate 4: Subcanopy Veg Percent Cover
set.seed(11)
subcan_pc <- rnorm(nP, mean = 1, sd = 1)
hist(subcan_pc, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Subcanopy Height")


# Covariate 5: Subcanopy Veg Complexity 
set.seed(12)
subcan_cx <- rnorm(nP, mean = 1, sd = 1)
hist(subcan_cx, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Subcanopy Complexity")

# Covariate 6: Overall Veg Density
set.seed(13)
veg_d <- rnorm(nP, mean = 1, sd = 1)
hist(veg_d, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Total Vegetation Density")

# Covariate 7: Canopy Height
set.seed(14)
can_h <- rnorm(nP, mean = 1, sd = 1)
hist(can_h, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Canopy Height")

# Covariate 8: Canopy Percent Cover
set.seed(15)
can_pc <- rnorm(nP, mean = 1, sd = 1)
hist(can_pc, col = cuckoo_palette[1], main = "Distribution of Simulated Scaled Canopy Cover")

# covariate effects (pull randomly for each covariate)
set.seed(5)
beta <- rnorm(nC, 0, 1)

psi0 <- qlogis(0.2) # probability of presence
p0 <- qlogis(0.6) # probability of detection

psi <- NULL
for (i in 1:nP){
  # How do I account for categorical variables here???????????????????????????????????????????????
  psi[i] = plogis(psi0 + (beta[1]*tree_rich[i]) + (beta[2]*shrub_com[i]) + (beta[3]*subcan_h[i]) + (beta[4]*subcan_pc) + (beta[5]*subcan_cx) + (beta[6]*veg_d) + (beta[7]*can_h) + (beta[8]*can_pc))
}
# Assume equal probability of presence at all sites with this simulation

# get your true presence/non presence values from psi
set.seed(8) # I changed this around until I got a value of presence/absence that looked good to me
z <- rbinom(nP, 1, psi)

# total number of detections across number of visits (nV)
y <- matrix(NA, nP, nV)
# fill in the detection matrix dependent on whether the animal was there (z) and whether it was detected (p0)
# add covariate effects here
set.seed(7)
for (i in 1:nP){
  for (j in 1:nV){
    y[i,j] <- rbinom(1, z[i], plogis(p0))
    # Assume equal probability of detection at all sites and all surveys
  }
}

# b1/beta[1] : 
# b2/beta[2] : 
# b3/beta[3] : 
# b4/beta[4] : 
```

```{R Set Up Model,eval = FALSE}
cat("
  model{
    # Loop through each sampling unit
    for(i in 1:n_unit){
      Z[i] ~ dbern(psi[i])  # Presence or absence drawn from a bernoulli distribution with occupancy probability psi  
      logit(psi[i]) <- a0
      
      cov2[i] ~ dnorm(0, 1) # Assuming normal distribution for missing covariates
      
      for(j in 1:n_rep){
        cov1[i,j] ~ dnorm(0, 1) # Assuming normal distribution for missing covariates
        cov3[i,j] ~ dnorm(0, 1) # Assuming normal distribution for missing covariates
        cov4[i,j] ~ dnorm(0, 1) # Assuming normal distribution for missing covariates
        
        det_data[i,j] ~  dbern(Z[i]*theta[i,j])  # Create detection data drawn from a bernoulli distribution incorporating the true presence (Z) with probability of detection theta
        logit(theta[i,j]) <- b0 + b1*cov1[i,j] + b2*cov2[i] + b3*cov3[i,j] + b4*cov4[i,j]
        
      }
    }
    
    # Priors
    a0 ~ dlogis(0, 1)
    b0 ~ dlogis(0, 1)
    b1 ~ dnorm(0, 1)
    b2 ~ dnorm(0, 1)
    b3 ~ dnorm(0, 1)
    b4 ~ dnorm(0, 1)
  }
  ", file = "./R_Scripts/2_Analyses/Habitat_Chapter/Detection_Submodel/Model_Structure_Files/Test_JAGS_Occ_DetectionModel2.txt")
```

*Next up:* Figure out what the parameterization of these models means



